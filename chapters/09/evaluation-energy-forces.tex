\chapter{Evaluation of energies and forces}

\section{Periodic boundary conditions}

$$U_{nb}(\vec{r}_1, \dots, \vec{r}_N) = \sum\limits_{i>j\in nb}\biggl\{4e_{ij}\biggl[\biggl(\frac{\sigma_{ij}}{r_{ij}}\biggr)^{12}-\biggl(\frac{\sigma_{ij}}{r_{ij}}\biggr)^6\biggr] + \frac{q_iq_j}{r_{ij}}\biggr\}$$

Periodic boundary conditions are a Fourier representation.
The idea is that any function that is long ranged in space will be short ranged in the reciprocal or Fourier space.
The strategy is to divide en impera the long and short ranged contributions.

	\subsection{The error function}
	An error function is defined such that:

	$$erf(x) = \frac{2}{\sqrt{\pi}}\int_o^x dte^{-t^2}$$

	This has some properties:

	\begin{multicols}{2}
		\begin{itemize}
			\item $\lim\limits_{x\rightarrow \infty}erf(x) = 1$.
			\item $erf(0) = 0$
		\end{itemize}
	\end{multicols}

	The complement error function is:

	$$erfc(x) = 1- erf(x) = \frac{2}{\sqrt{\pi}}\int_x^\infty dte^{-t^2}$$

	Such that:

	\begin{multicols}{2}
		\begin{itemize}
			\item $\lim\limits_{x\rightarrow\infty} erfc = 0$.
			\item $erf(x) + erfc(x) = 1$.
		\end{itemize}
	\end{multicols}

	$$\frac{1}{r} = \overbrace{\frac{erfc{\alpha r}}{r}^{\text{short-ranged}} + \overbrace{\frac{erf(\alpha r)}{r}}^{\text{long-ranged}}}$$

	\subsection{Divide et impera}

	$$U_{nb}(\vec{r}_1, \dots, \vec{r}_N) = U_{short}(\vec{r}_1, \dots, \vec{r}_N) + U_{long}(\vec{r}_1, \dots, \vec{r}_n)$$

	$$U_{short}(\vec{r}_1, \dots, \vec{r}_N) = \sum\limits_{\vec{S}}\sum\limits_{i>j\in nb}\biggl\{4\epsilon_{ij}\biggl[\biggl(\frac{\sigma_{ij}}{r_{ij,\vec{S}}}\biggr)^{12}-\biggl(\frac{\sigma_{ij}}{r_{ij, \vec{S}}}\biggr)^6\biggr] + \frac{q_iq_jerfc(\alpha r_{ij, \vec{S}})}{r_{ij, \vec{S}}}\biggr\}$$

	$$U_{long}(\vec{r}_1, \dots, \vec{r}_N) = \sum\limits_S\sum\limits_{i>j\in nb} \frac{q_iq_j erf(\alpha r_{ij, \vec{S}})}{r_{ij, \vec{S}}}$$

	$$r_{ij, \vec{S}} = |\vec{r}_i-\vec{r}_j + \vec{S}|\qquad \vec{S} = \vec{m}L$$

	So the original distribution of charges is equal to the sum in direct space of the screened electrostatic interactions and the sum in reciprocal space of the Gaussian clouds of charges.

\section{Short range forces}

$$U_{short}(\vec{r}_1, \dots, \vec{r}_N) = \sum\limits_{\vec{S}}\sum\limits_{i>j\in nb}\biggl\{4\epsilon_{ij}\biggl[\biggl(\frac{\sigma_{ij}}{r_{ij, \vec{S}}}\biggr)^{12} - \biggl(\frac{\sigma_{ij}}{r_{ij, \vec{S}}}\biggr)^{6}\biggr] + \frac{q_iq_jerfc(\alpha r_{ij, \vec{S}})}r_{ij, \vec{S}}\biggr\}$$

Considering a cutoff radius $r_C\approx 10$-$12\si{\angstrom}$ and $\alpha = \frac{3.5}{r_C}$:

$$\tilde{U}_{short}(r_{ij}) = \begin{cases} U_{short}(r_{ij}) - U_{short}(r_C) & r<r_C\\ 0 & r>r_C\end{cases}$$

So the force is discontinuous.

	\subsection{Switching function}

	$$\tilde{U}_{short}(r-{ij}) = U_{short}(r_{ij})S(r_{ij})\qquad S(r) = \begin{cases} 1 & r<r_C-\lambda\\ 1 + \biggl(\frac{r-r_C+\lambda}{\lambda}\biggr)^2\biggl(2\frac{r-r_C + \lambda}{\lambda} - 3\biggr) & r_c -\lambda < r\le r_C\\0 & r> r_C\end{cases}$$

	Corrections to energy and pressure are required.

\section{Minimum image convention}
Particle $i$ interacts with the periodic image of particle $j$ to which it is closest.

	\subsection{Verlet Neighbour list}

	\begin{multicols}{2}
		\begin{enumerate}
			\item A list of neighbours for all particles is given.
			\item At each time step $k\Delta t$ the displacements $\Delta_i = |\vec{r}_i(k\Delta t) - \vec{r}_i(0)|$ is computed.
			\item $\Delta_{\max} = \max\Delta_i$.
			\item If $\Delta_{\max} > \frac{\delta}{2}$ the lists are updated.
		\end{enumerate}
	\end{multicols}

	In a more efficient alternative the system is divided into cells of size equal or slightly larger than $r_C$.

\section{Long range forces}
Considering a cubic cell of volume $V = L^3$ the reciprocal space vectors are $\vec{g} = \frac{2\pi}{L}\vec{n}$.
Considering the Poisson summation rule:

$$\sum\limits_{\vec{S}}\frac{erf(\alpha|\vec{r} + \vec{S}|)}{|\vec{r}+\vec{S}|} = \frac{1}{V}\sum\limits_{\vec{g}}C_{\vec{g}}e^{i\vec{g}\cdot\vec{r}}$$

$$C_{\vec{g}} = \sum\limits_{\vec{S}}\int_{D(V)} d\vec{r}\frac{erf(\alpha|\vec{r}+\vec{S}|)}{|\vec{r}+\vec{S}|}e^{-i\vec{g}\cdot\vec{r}} = \int_{\text{all space}}d\vec{r}\frac{erf(\alpha r)}{r}e^{i\vec{g}\cdot\vec{r}} = \frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}}$$

The term $\vec{n} = \begin{pmatrix} 0&0&0\end{pmatrix}$ is not included.
The sum is truncated with $|\vec{g}|<g_{max}$.

	\subsection{Summing up}
	Considering that $C_{\vec{g}} = C_{-\vec{g}}$ and $\mathcal{S}$ the positive hemisphere:

	$$\frac{1}{V}\sum\limits_{\vec{g}}C_{\vec{g}}e^{i\vec{g}\cdot\vec{r}} = \frac{2}{V}\sum\limits_{i>j}q_iq_j\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{2\alpha^2}}e^{i\vec{g}\cdot(\vec{r}_i-\vec{r}_j)}$$

	Adding and subtracting the term with $i = j$:

	$$U_{long} = \frac{1}{V}\sum\limits_{i, j}q_iq_j\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|}{4\alpha^2}}e^{i\vec{g}\cdot(\vec{r}_i-\vec{r}_j)}-\frac{1}{V}\sum\limits_iq_i^2\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}}$$

	Thus:

	$$U_{long} = \frac{1}{V}\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}^2}{4\alpha^2}}|\sum\limits_{i}q_ie^{\vec{g}\cdot\vec{r}_i}|^2 - \frac{1}{V}\sum\limits_iq_i^2\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}}$$

	\subsection{Ewald sum}

	\begin{align*}
		U_{long} &= \frac{1}{V}\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}^2}{4\alpha^2}}|\sum\limits_{i}q_ie^{\vec{g}\cdot\vec{r}_i}|^2 - \frac{1}{V}\sum\limits_iq_i^2\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}} = \\
						 &= \frac{1}{V}\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}}|S(g)|^2-\frac{1}{2V}\sum\limits_{i}q_i^2\sum\limits_{g\neq\begin{pmatrix} 0&0&0\end{pmatrix}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}}
	\end{align*}

	However:

	$$\frac{1}{V}\sum\limits_{\vec{g}\neq\begin{pmatrix}0&0&0&0\end{pmatrix}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}} = \lim\limits_{r\rightarrow 0}\frac{erf(\alpha r)}{r} = \lim\limits_{r\rightarrow 0}\frac{2}{r\sqrt{\pi}}\int_0^{\alpha r}e^{-t^2}dt = \lim\limits_{r\rightarrow 0}\frac{2\alpha e^{-\alpha^2r^2}}{\sqrt{\pi}} = \frac{2\alpha}{\sqrt{\pi}}$$

	Considering the self-interaction correction:

	$$U_{long} = \frac{1}{V}\sum\limits_{\vec{g}\in\mathcal{S}}\frac{4\pi}{|\vec{g}|^2}e^{-\frac{|\vec{g}|^2}{4\alpha^2}}|S(g)|^2-\frac{\alpha}{\sqrt{\pi}}\sum\limits_iq_i^2$$

\section{Alternatives}
The structure factor $S(\vec{g})$ leads to an interaction between all charged particles, so unwanted interactions need to be subtracted.

	\subsection{Smooth particle mesh Ewald}
	The smooth particle mesh Ewald SPME method uses splines to interpolate charge distributions on a grid.

	\subsection{Particle-particle particle-mesh Ewald}
	The particle-particle particle mesh Ewald or PPPM or P3M uses the density function to compute the structure factor:

	$$\rho(\vec{g}) = \int d\vec{r}\rho(\vec{r})e^{i\vec{g}\cdot\vec{r}} = \sum\limits_i q_i e^{i\vec{g}\cdot\vec{r}_i}$$

	$$\rho(\vec{r}) = \sum\limits_{i}q_i\delta(\vec{r}-\vec{r}_i)$$

	Considering Poisson equation:

	$$\nabla^2\phi(\vec{r}) = -\nabla\cdot\vec{E} = -4\pi\rho(\vec{r})$$

	And the reciprocal space:

	$$g^2\phi(\vec{g}) = 4\pi\rho(\vec{g}) = 4\pi S(\vec{G})$$

	\subsection{Other cheap options}
	Other cheap options include:

	\begin{multicols}{2}
		\begin{itemize}
			\item Spherical truncation.
			\item Reaction field on a molecule.
			\item Fast multiple methods FMM.
			\item Multilevel summation method MSM,
			\item Maxwell equation molecular dynamics MEMD.
		\end{itemize}
	\end{multicols}
